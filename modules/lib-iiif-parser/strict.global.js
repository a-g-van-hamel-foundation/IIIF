"use strict";var IIIFParser=(()=>{var y=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var M=Object.prototype.hasOwnProperty;var x=(n,e,a)=>e in n?y(n,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):n[e]=a;var L=(n,e)=>{for(var a in e)y(n,a,{get:e[a],enumerable:!0})},k=(n,e,a,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of S(e))!M.call(n,r)&&r!==a&&y(n,r,{get:()=>e[r],enumerable:!(t=I(e,r))||t.enumerable});return n};var D=n=>k(y({},"__esModule",{value:!0}),n);var o=(n,e,a)=>(x(n,typeof e!="symbol"?e+"":e,a),a);var N={};L(N,{presentation3StrictUpgrade:()=>G});function c(n){return typeof n=="string"?!1:n&&!n.type&&"source"in n?(n.type="SpecificResource",!0):!!n&&n.type==="SpecificResource"}function v(n){return Array.isArray(n)?n:n?[n]:[]}function f(...n){return e=>n.reduce((a,t)=>t(a),e)}var R=["Collection","Manifest","Canvas","AnnotationPage","AnnotationCollection","Annotation","ContentResource","Range","Service","Selector","Agent"];function $(n,e){if(typeof n>"u"||n===null)throw new Error("Null or undefined is not a valid entity.");if(Array.isArray(n))throw new Error("Array is not a valid entity");if(typeof n!="object"){if(e)return e;throw new Error(`${typeof n} is not a valid entity`)}if(typeof n.type=="string"){let a=R.indexOf(n.type);if(a!==-1)return R[a]}if(n.profile)return"Service";throw new Error("Resource type is not known")}var d=class n{constructor(e,a={}){o(this,"traversals");o(this,"options");o(this,"_traverseManifest",f(this.traverseManifestItems.bind(this),this.traverseLinking.bind(this),this.traverseDescriptive.bind(this),this.traverseLinkedCanvases.bind(this),this.traverseManifestStructures.bind(this),this.traverseInlineAnnotationPages.bind(this)));o(this,"_traverseCanvas",f(this.traverseCanvasItems.bind(this),this.traverseLinking.bind(this),this.traverseDescriptive.bind(this),this.traverseLinkedCanvases.bind(this),this.traverseInlineAnnotationPages.bind(this)));o(this,"_traverseAnnotationPage",f(this.traverseAnnotationPageItems.bind(this),this.traverseLinking.bind(this),this.traverseDescriptive.bind(this)));o(this,"_traverseRange",f(this.traverseRangeRanges.bind(this),this.traverseLinking.bind(this),this.traverseDescriptive.bind(this),this.traverseLinkedCanvases.bind(this)));this.traversals={collection:[],manifest:[],canvas:[],annotationCollection:[],annotationPage:[],annotation:[],contentResource:[],choice:[],range:[],service:[],agent:[],specificResource:[],geoJson:[],...e},this.options={allowUndefinedReturn:!1,...a}}static all(e){return new n({collection:[e],manifest:[e],canvas:[e],annotationCollection:[e],annotationPage:[e],annotation:[e],contentResource:[e],choice:[e],range:[e],service:[e],geoJson:[e],specificResource:[e],agent:[e]})}traverseDescriptive(e){return e.thumbnail&&(e.thumbnail=v(e.thumbnail).map(a=>this.traverseType(a,{parent:e},this.traversals.contentResource))),e.provider&&(e.provider=e.provider.map(a=>this.traverseAgent(a,e))),e}traverseLinking(e){return e.seeAlso&&(e.seeAlso=e.seeAlso.map(a=>this.traverseType(a,{parent:e},this.traversals.contentResource))),e.service&&(e.service=v(e.service).map(a=>this.traverseService(a))),e.services&&(e.services=v(e.services).map(a=>this.traverseService(a,e))),e.logo&&(e.logo=e.logo.map(a=>this.traverseType(a,{parent:e},this.traversals.contentResource))),e.homepage&&(e.homepage=v(e.homepage).map(a=>this.traverseType(a,{parent:e},this.traversals.contentResource))),e.partOf&&(e.partOf=e.partOf.map(a=>typeof a=="string"||!a.type?this.traverseType(a,{parent:e},this.traversals.contentResource):a.type==="Canvas"?this.traverseType(a,{parent:e},this.traversals.canvas):a.type==="AnnotationCollection"?this.traverseType(a,{parent:e},this.traversals.annotationCollection):a.type==="Collection"?this.traverseType(a,{parent:e},this.traversals.collection):this.traverseType(a,{parent:e},this.traversals.contentResource))),e.start&&(c(e.start)?e.start=this.traverseSpecificResource(e.start,"Canvas",e):e.start=this.traverseType(e.start,{parent:e},this.traversals.canvas)),e.rendering&&(e.rendering=e.rendering.map(a=>this.traverseType(a,{parent:e},this.traversals.contentResource))),e.supplementary&&(e.supplementary=e.supplementary.map(a=>this.traverseType(a,{parent:e},this.traversals.contentResource))),e}traverseCollectionItems(e){return e.items&&e.items.map(a=>a.type==="Collection"?this.traverseCollection(a):this.traverseManifest(a)),e}traverseCollection(e,a){return this.traverseType(this.traverseDescriptive(this.traverseInlineAnnotationPages(this.traverseLinking(this.traverseLinkedCanvases(this.traverseCollectionItems(e))))),{parent:a},this.traversals.collection)}traverseGeoJson(e,a){return this.traverseType(e,{parent:a},this.traversals.geoJson)}traverseNavPlace(e){return e.navPlace&&(e.navPlace=this.traverseGeoJson(e.navPlace,e)),e}traverseManifestItems(e){return e.items&&(e.items=e.items.map(a=>this.traverseCanvas(a))),e}traverseManifestStructures(e){return e.structures&&(e.structures=e.structures.map(a=>this.traverseRange(a))),e}traverseManifest(e,a){return this.traverseType(this._traverseManifest(e),{parent:a},this.traversals.manifest)}traverseCanvasItems(e){return e.items=(e.items||[]).map(a=>this.traverseAnnotationPage(a,e)),e}traverseInlineAnnotationPages(e){return typeof e=="string"||!e||e.annotations&&(e.annotations=e.annotations.map(a=>this.traverseAnnotationPage(a,e))),e}traverseCanvas(e,a){return this.traverseType(this._traverseCanvas(e),{parent:a},this.traversals.canvas)}traverseAnnotationPageItems(e){return e.items&&(e.items=e.items.map(a=>this.traverseAnnotation(a,e))),e}traverseAnnotationPage(e,a){return this.traverseType(this._traverseAnnotationPage(e),{parent:a},this.traversals.annotationPage)}traverseAnnotationBody(e){return Array.isArray(e.body)?e.body=e.body.map(a=>this.traverseContentResource(a,e)):e.body&&(e.body=this.traverseContentResource(e.body,e)),e}traverseLinkedCanvases(e){return e.placeholderCanvas&&(e.placeholderCanvas=this.traverseCanvas(e.placeholderCanvas)),e.accompanyingCanvas&&(e.accompanyingCanvas=this.traverseCanvas(e.accompanyingCanvas)),e}traverseAnnotation(e,a){return this.traverseType(this.traverseLinking(this.traverseAnnotationBody(this.traverseDescriptive(e))),{parent:a},this.traversals.annotation)}traverseContentResourceLinking(e){return typeof e=="string"||!e||e&&e.service&&(e.service=v(e.service||[]).map(a=>this.traverseService(a,e))),e}traverseContentResource(e,a){return e.type==="Choice"&&(e.items=e.items.map(t=>this.traverseContentResource(t,e))),c(e)?this.traverseSpecificResource(e,"ContentResource"):this.traverseType(this.traverseInlineAnnotationPages(this.traverseContentResourceLinking(e)),{parent:a},this.traversals.contentResource)}traverseSpecificResource(e,a,t){let r=e.source;return typeof e.source=="string"&&(r={id:e.source,type:a||"unknown"}),this.traverseType({...e,source:a==="Canvas"||r.type==="Canvas"?this.traverseType(r,{parent:t},this.traversals.canvas):a==="ContentResource"?this.traverseContentResource(r,{parent:t}):this.traverseUnknown(r,{parent:t,typeHint:a})},{parent:t},this.traversals.specificResource)}traverseRangeRanges(e){return e.items&&(e.items=e.items.map(a=>typeof a=="string"?this.traverseCanvas({id:a,type:"Canvas"},e):c(a)?this.traverseSpecificResource(a,"Canvas",e):a.type==="Manifest"?this.traverseManifest(a,e):this.traverseRange(a,e))),e}traverseRange(e,a){return this.traverseType(this._traverseRange(e),{parent:a},this.traversals.range)}traverseAgent(e,a){return this.traverseType(this.traverseDescriptive(this.traverseLinking(e)),{parent:a},this.traversals.agent)}traverseType(e,a,t){return t.reduce((r,l)=>{let h=l(r,a);return typeof h>"u"&&!this.options.allowUndefinedReturn?r:h},e)}traverseService(e,a){let t=Object.assign({},e);return t&&t.service&&(t.service=v(t.service).map(r=>this.traverseService(r))),this.traverseType(t,{parent:a},this.traversals.service)}traverseUnknown(e,{parent:a,typeHint:t}={}){let r=$(e,t);switch(r){case"Collection":return this.traverseCollection(e,a);case"Manifest":return this.traverseManifest(e,a);case"Canvas":return this.traverseCanvas(e,a);case"AnnotationPage":return this.traverseAnnotationPage(e,a);case"Annotation":return this.traverseAnnotation(e,a);case"ContentResource":return this.traverseContentResource(e,a);case"Range":return this.traverseRange(e,a);case"Service":return this.traverseService(e,a);case"Agent":return this.traverseAgent(e,a);default:throw new Error(`Unknown or unsupported resource type of ${r}`)}}};function P(n){for(let e in n)(typeof n[e]>"u"||n[e]===null)&&delete n[e];return n}var U=/-?([1-9]\d{3,}|0\d{3})-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01])T(([01]\d|2[0-3]):[0-5]\d:[0-5]\d(\.\d+)?|(24:00:00(\.0+)?))(Z|(\+|-)((0\d|1[0-3]):[0-5]\d|14:00))?/,i={warnings:[]};function E(n,e=i){return n.behavior&&(n.behavior=s(n.behavior,"behavior",e)),n.width=C(n.width,"width",!1,e),n.height=C(n.height,"height",!1,e),n.duration=C(n.duration,"duration",!0,e),n.format&&typeof n.format!="string"&&(e.warnings.push('"format" should be a single string'),Array.isArray(n.format)&&typeof n.format[0]=="string"?n.format=n.format[0]:n.format=void 0),n}function m(n,e,a=i){return n&&Array.isArray(n)?n.filter(t=>{let r=e(t);return r&&a.warnings.indexOf(r)===-1&&a.warnings.push(r),!r}):n}function s(n,e,a=i){return Array.isArray(n)?n:(a.warnings.push(`"${e}" should be Array of values`),[n])}function A(n,e,a=i){return Array.isArray(n)?(a.warnings.push(`"${e}" should only contain a single value`),n.length===0?void 0:n[0]):n}function C(n,e,a=!1,t=i){if(!(typeof n>"u")){if(typeof n=="string"){let r=a?parseFloat(n):Math.abs(Number(n));if(Number.isNaN(r)||r<=0){t.warnings.push(`"${e}" expected value to be a ${a?"Number":"Integer"}, instead found an invalid value`);return}return t.warnings.push(`"${e}" expected value to be a ${a?"Number":"Integer"}, instead found a string`),r}return!a&&n%1!==0?(t.warnings.push(`"${e}" expected value to be a Integer, instead found a Float`),Math.floor(n)):n}}function g(n,e,a=i){if(Array.isArray(n))return typeof n[0]=="string"?(a.warnings.push(`"${e}" should be a language map instead found a string`),{none:n}):(a.warnings.push(`"${e}" should be a language map instead found an unknown value`),{none:[""]});if(typeof n=="string")return a.warnings.push(`"${e}" should be a language map instead found a string`),{none:[n]};let t=Object.keys(n),r={},l=!1;for(let h of t){let p=n[h],u=[];if(typeof p=="string")l=!0,a.warnings.push(`"${e}" values inside a language map should be an Array of strings, found a string`),u.push(p);else if(Array.isArray(p))for(let T of p)typeof T!="string"?(l=!0,a.warnings.push(`"${e}" values inside a language map should be an Array of strings, found an unknown value`)):u.push(T);else l=!0,a.warnings.push(`"${e}" values inside a language map should be an Array of strings, found an unknown value`);u.length>0&&(r[h]=u)}return l?Object.keys(r).length===0?{none:[""]}:r:n}function b(n,e,a="",t=i){return typeof n=="string"?(t.warnings.push(`"${e}" should be a {label, value} set of Language maps`),{label:{none:[a]},value:{none:[n]}}):((!n.label&&n.value||n.label&&!n.value)&&t.warnings.push(`"${e}" should have both a label and a value`),n.label?n.label=g(n.label,`${e}.label`,t):n.label={none:[a]},n.value?n.value=g(n.value,`${e}.value`,t):n.value={none:[""]},n)}function W(n,e=i){if(n.label&&(n.label=g(n.label,"label",e)),n.summary&&(n.summary=g(n.summary,"summary",e)),n.requiredStatement&&(n.requiredStatement=b(n.requiredStatement,"requiredStatement","Required statement",e)),n.metadata)if(Array.isArray(n.metadata))for(let a=0;a<n.metadata.length;a++)n.metadata[a]=b(n.metadata[a],`metadata.${a}`,"",e);else e.warnings.push('"metadata" should be an array of {label, value} Language maps'),n.metadata=[];if(n.rights&&(Array.isArray(n.rights)&&(e.warnings.push('"rights" should only contain a single string'),n.rights=typeof n.rights[0]=="string"?n.rights[0]:""),typeof n.rights=="string"&&!n.rights.startsWith("http")?e.warnings.push('"rights" should be a valid URI'):typeof n.rights=="string"&&n.rights.startsWith("https")&&(e.warnings.push('"rights" is an informative property and should contain the http variation of the rights statement'),n.rights=`http${n.rights.slice(5)}`)),n.navDate){let a=typeof n.navDate=="string"?n.navDate.trim():void 0;a!==n.navDate&&(e.warnings.push('"navDate" should not contain extra whitespace'),n.navDate=a),(typeof n.navDate!="string"||!n.navDate.match(U))&&(e.warnings.push('"navDate" should be a valid XSD dateTime literal'),n.navDate=void 0)}return n.language&&(n.language=s(n.language,"language",e),n.language=m(n.language,a=>typeof a=="string"?void 0:`'"language" expected array of strings`,e)),n.accompanyingCanvas&&(n.accompanyingCanvas=A(n.accompanyingCanvas,"accompanyingCanvas",e),n.accompanyingCanvas?.type!=="Canvas"&&e.warnings.push('"accompanyingCanvas" should be a Canvas')),n.placeholderCanvas&&(n.placeholderCanvas=A(n.placeholderCanvas,"placeholderCanvas",e),n.placeholderCanvas?.type!=="Canvas"&&e.warnings.push('"placeholderCanvas" should be a Canvas')),n.thumbnail&&(n.thumbnail=s(n.thumbnail,"thumbnail",e)),n}var w={Manifest:"Canvas",Canvas:"AnnotationPage",AnnotationPage:"Annotation"};function _(n,e=i){let a=n.type;switch(a){case"Canvas":case"AnnotationPage":case"Manifest":n&&n.items&&(n.items=m(n.items,t=>t.type===w[a]?void 0:`"${n.type}.items" should contain only type ${w[a]}, found ${t.type}`,e))}return n}function q(n,e=i){return n.logo&&(n.logo=s(n.logo,"logo",e)),n.service&&(n.service=s(n.service,"service",e)),n.seeAlso&&(n.seeAlso=s(n.seeAlso,"seeAlso",e)),n.rendering&&(n.rendering=s(n.rendering,"rendering",e)),n.partOf&&(n.partOf=s(n.partOf,"partOf",e)),n.homepage&&(n.homepage=s(n.homepage,"homepage",e)),n.services&&(n.services=s(n.services,"services",e)),n.supplementary&&(n.supplementary=s(n.supplementary,"supplementary",e)),n.start&&(n.start=A(n.start,"start",e)),n}function B(n){return e=>{if(e)return typeof e=="string"||Array.isArray(e)?e:P({...e,...E(e,n),...W(e,n),...q(e,n),..._(e,n)})}}function G(n,e=i){return d.all(B(e)).traverseManifest(n)}return D(N);})();
